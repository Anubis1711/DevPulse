<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevPulse Feed</title>
    <link rel="stylesheet" href="/feed.css">
    <link rel="stylesheet" href="/sidebar.css">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function fetchCommits(repoFullName) {
            if (!repoFullName) return;

            const response = await fetch(`/commits?repo=${repoFullName}`);
            if (response.ok) {
                const commits = await response.json();
                const commitSelect = document.getElementById('commitInfo');
                commitSelect.innerHTML = '<option value="">Selecteer een commit (optioneel)</option>';

                commits.forEach(commit => {
                    const option = document.createElement('option');
                    option.value = `${repoFullName},${commit.sha}`;
                    option.text = `${commit.commit.message || "Geen bericht"} - ${commit.commit.author ? commit.commit.author.name : "Onbekende auteur"}`;
                    commitSelect.appendChild(option);
                });
            } else {
                console.error('Er ging iets mis bij het ophalen van de commits');
            }
        }

        function toggleDropdown(id) {
            const element = document.getElementById(id);
            element.style.display = element.style.display === "none" ? "block" : "none";
        }

        function togglePostForm() {
            const postForm = document.getElementById('postForm');
            postForm.style.display = postForm.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <img src="/icons/DevPulse-logo.svg" alt="DevPulse Logo" class="logo-image">
            <h2>DevPulse</h2>
        </div>
        <ul class="nav-links">
            <li><a href="/profile">Profile</a></li>
            <li><a href="/feed">Feed</a></li>
            <li><a href="/comparison">side-by-side comparison</a></li>
            <li><a href="/logout">Log out</a></li>
        </ul>
    </div>

    <!-- Zoekbalk -->
    <div class="main-content">
        <form action="/feed/search" method="GET" class="search-bar">
            <input type="text" name="q" placeholder="Zoek gebruikers..." required>
            <button type="submit">Zoeken</button>
        </form>

        <!-- Knop om formulier te tonen -->
        <button onclick="togglePostForm()" class="post-toggle-button">
            Maak een Post
        </button>

        <!-- Verborgen postformulier -->
        <div id="postForm" class="post-form" style="display: none;">
            <form action="/feed/new" method="POST">
                <textarea name="content" placeholder="Wat heb je gedaan vandaag met je project?" required></textarea>
                <select name="repository" id="repository" onchange="fetchCommits(this.value)">
                    <option value="">Selecteer een repository (optioneel)</option>
                    <% repositories.forEach(function(repo) { %>
                        <option value="<%= repo.full_name %>"><%= repo.name %></option>
                    <% }); %>
                </select>
                <select name="commitInfo" id="commitInfo">
                    <option value="">Selecteer een commit (optioneel)</option>
                </select>
                <input type="text" name="imageUrl" placeholder="URL van afbeelding (optioneel)">
                <button type="submit">Post!</button>
            </form>
        </div>

        <!-- Posts -->
        <div class="profile-info">
            <% posts.forEach((post, index) => { %>
                <div class="post">
                    <h3>Gepost door: <%= post.author.login %></h3>
                    <p><%= post.content %></p>
                    <% if (post.commitInfo) { %>
                        <p><strong>Commit Message:</strong> <%= post.commitInfo.message %></p>
                        <p><strong>Author:</strong> <%= post.commitInfo.author %></p>

                        <!-- Grafiek -->
                        <div>
                            <canvas id="fileChangesChart-<%= index %>" width="400" height="200"></canvas>
                        </div>

                        <!-- Dropdown: Wijzigingen -->
                        <button onclick="toggleDropdown('changes-<%= index %>')">Wijzigingen</button>
                        <div id="changes-<%= index %>" style="display: none;">
                            <p>Additions: <%= post.commitInfo.additions %></p>
                            <p>Deletions: <%= post.commitInfo.deletions %></p>
                        </div>

                        <!-- Dropdown: Bestanden gewijzigd -->
                        <button onclick="toggleDropdown('files-<%= index %>')">Bestanden gewijzigd</button>
                        <div id="files-<%= index %>" style="display: none;">
                            <% post.commitInfo.files.forEach(file => { %>
                                <p><strong>Bestand:</strong> <%= file.filename %> (Additions: <%= file.additions %>, Deletions: <%= file.deletions %>)</p>
                            <% }); %>
                        </div>

                        <script>
                            const ctx<%= index %> = document.getElementById('fileChangesChart-<%= index %>').getContext('2d');
                            new Chart(ctx<%= index %>, {
                                type: 'bar',
                                data: {
                                    labels: <%- JSON.stringify(post.commitInfo.files.map(file => file.filename)) %>,
                                    datasets: [
                                        { label: 'Toevoegingen', data: <%- JSON.stringify(post.commitInfo.files.map(file => file.additions)) %> },
                                        { label: 'Verwijderingen', data: <%- JSON.stringify(post.commitInfo.files.map(file => file.deletions)) %> }
                                    ]
                                }
                            });
                        </script>
                    <% } %>
                </div>
            <% }); %>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <p>Â© 2024 DevPulse. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>
